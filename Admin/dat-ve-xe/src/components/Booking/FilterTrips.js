import React, {useEffect, useState} from "react";
import {Card, Button, Checkbox, Slider, Input, Rate, message} from "antd";
import AddCircleIcon from "@mui/icons-material/AddCircle";
import RemoveIcon from "@mui/icons-material/Remove";
import Remove from "@mui/icons-material/Remove";
import {useDispatch, useSelector} from "react-redux";
import {FILTER_TRIPPASSENGER_TIME} from "../../redux/types/TripTypes";
import {FilterTimeTripPassengerAction, FilterPriceTripPassengerAction, FilterTypeTripPassengerAction, getTripPassengerAction, FilterBlankTripPassengerAction, FilterPassengerTripPassengerAction, getTripPassenger2Action, FilterSeatTripPassengerAction, FilterRateTripPassengerAction, getTripPassengersByTripsAction} from "../../redux/actions/tripAction";
import _ from "lodash";
import {CANCEL_SORT_TIME, SET_SORT_TIME} from "../../redux/types/BookingTypes";
const {Search} = Input;

export default function FilterTrips(props) {
	const dispatch = useDispatch();
	let {listTripPassenger, listTripPassenger2, originalListTripPassenger} = useSelector((state) => state.BookingReducer);

	let arrFilterPassenger = _.uniqBy(listTripPassenger2, "passengerId");
	useEffect(() => {
		if (props.tripIds && props.tripIds.length > 0) {
			dispatch(getTripPassengersByTripsAction(props.tripIds));
		}
	}, [props.tripIds]);

	const [minmax, setMinMax] = useState([0, 5000000]);
	const [gheTrong, setGheTrong] = useState(1);
	const [btnActive, setBtnActive] = useState({
		activeObject: null,
		objects: [
			{id: 1, filterTime: "00:00 - 06:00", time: "S√°ng s·ªõm", timeStart: "00:00:00", timeEnd: "06:00:00"},
			{id: 2, filterTime: "06:01 - 12:00", time: "Bu·ªïi s√°ng", timeStart: "06:01:00", timeEnd: "12:00:00"},
			{id: 3, filterTime: "12:01 - 18:00", time: "Bu·ªïi chi·ªÅu", timeStart: "12:01:00", timeEnd: "18:00:00"},
			{id: 4, filterTime: "18:01 - 23:59", time: "Bu·ªïi t·ªëi", timeStart: "18:01:00", timeEnd: "23:59:00"},
		],
	});

	const [selectedPassengers, setSelectedPassengers] = useState([]);

	const renderPassenger = () => {
		return arrFilterPassenger.map((item) => (
			<Checkbox
				key={item.passengerId}
				checked={selectedPassengers.includes(item.passengerId)}
				onChange={(e) => {
					let newSelected;
					if (e.target.checked) {
						newSelected = [...selectedPassengers, item.passengerId];
					} else {
						newSelected = selectedPassengers.filter((id) => id !== item.passengerId);
					}

					setSelectedPassengers(newSelected);

					// L·ªçc d·ªØ li·ªáu ·ªü ƒë√¢y
					if (newSelected.length > 0) {
						const filtered = originalListTripPassenger.filter((trip) => newSelected.includes(trip.passengerId));

						dispatch({
							type: "GET_TRIP_PASSENGER",
							listTripPassenger: filtered,
						});
					} else {
						// N·∫øu kh√¥ng ch·ªçn g√¨ ‚Üí reset
						dispatch({
							type: "GET_TRIP_PASSENGER",
							listTripPassenger: originalListTripPassenger,
						});
					}
				}}
			>
				{item.passenger?.name}
			</Checkbox>
		));
	};

	function toggleActive(index) {
		if (btnActive.objects[index] === btnActive.activeObject) {
			setBtnActive({...btnActive, activeObject: null});
			dispatch({
				type: CANCEL_SORT_TIME,
			});
		} else {
			setBtnActive({...btnActive, activeObject: btnActive.objects[index]});
			dispatch({
				type: SET_SORT_TIME,
			});
		}
	}
	function toggleActiveStyle(index) {
		if (btnActive.objects[index] === btnActive.activeObject) {
			return "active-filterTime";
		} else {
			return "";
		}
	}

	return (
		<div className="filter_trip">
			<div style={{display: "block"}}>
				<span className="grLeft-label-left font-bold text-xl">B·ªô l·ªçc t√¨m ki·∫øm</span>
			</div>
			<Card style={{width: 300}}>
				<div classname="list_time">
					<div className="Times__Contain0101er-sc-1ny42po-0 gTjoUi filter-times-container groupStyle">
						<p className="base__Body02Highlight-sc-1tvbuqk-15 cACxVN filter-name labelStyle font-bold">Gi·ªù ƒëi</p>
						<div className="time_filter">
							{btnActive.objects.map((element, index) => {
								return (
									<Button
										key={index}
										className={toggleActiveStyle(index)}
										onClick={() => {
											const isCurrentlyActive = btnActive.objects[index] === btnActive.activeObject;

											toggleActive(index);

											// N·∫øu ƒëang b·∫•m v√†o ch√≠nh button ƒëang ƒë∆∞·ª£c ch·ªçn ‚Üí b·ªè ch·ªçn (reset danh s√°ch)
											if (isCurrentlyActive) {
												dispatch({
													type: "GET_TRIP_PASSENGER",
													listTripPassenger: originalListTripPassenger,
												});
												return;
											}

											// console.log("check l·∫°i d·ªØ li·ªáu  ", listTripPassenger);

											const filteredTrips = originalListTripPassenger.filter((trip) => {
												if (!trip.startTime) return false;
												return trip.startTime >= element.timeStart && trip.startTime <= element.timeEnd;
											});

											// console.log(`D·ªØ li·ªáu sau khi l·ªçc theo kho·∫£ng ${element.filterTime}:`, filteredTrips);

											if (filteredTrips.length > 0) {
												const dataNew = filteredTrips.map((item) => ({
													...item,
													openDetail: false,
													openBooking: false,
													isOpen: false,
												}));

												dispatch({
													type: "GET_TRIP_PASSENGER",
													listTripPassenger: dataNew,
												});
											} else {
												dispatch({
													type: "GET_TRIP_PASSENGER",
													listTripPassenger: [],
												});
												message.error("Kh√¥ng c√≥ chuy·∫øn n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn");
											}
										}}
									>
										<p className="option-label">{element.time}</p>
										<p className="option-value">{element.filterTime}</p>
									</Button>
								);
							})}
						</div>
					</div>
				</div>
				<div className="filter_price">
					<p className="base__Body02Highlight-sc-1tvbuqk-15 cACxVN filter-name labelStyle font-bold">Gi√° v√©</p>
					<Slider
						range={{draggableTrack: true}}
						step={50000}
						min={0}
						max={5000000}
						defaultValue={minmax}
						onChange={(e) => {
							setMinMax([e[0], e[1]]);
						}}
						onAfterChange={(e) => {
							const [min, max] = e;

							console.log("üì¶ D·ªØ li·ªáu tr∆∞·ªõc khi l·ªçc theo gi√°:", listTripPassenger);
							console.log(`üîç L·ªçc v·ªõi kho·∫£ng gi√°: ${min.toLocaleString()} ƒë - ${max.toLocaleString()} ƒë`);

							// L·ªçc ƒë√∫ng theo passenger.price
							const filtered = originalListTripPassenger.filter((trip) => {
								return trip.passenger?.price >= min && trip.passenger?.price <= max;
							});

							console.log("‚úÖ D·ªØ li·ªáu sau khi l·ªçc:", filtered);

							if (filtered.length > 0) {
								const dataNew = filtered.map((item) => ({
									...item,
									openDetail: false,
									openBooking: false,
									isOpen: false,
								}));

								dispatch({
									type: "GET_TRIP_PASSENGER",
									listTripPassenger: dataNew,
								});
							} else {
								dispatch({
									type: "GET_TRIP_PASSENGER",
									listTripPassenger: [],
								});
								message.error("Kh√¥ng c√≥ chuy·∫øn n√†o trong kho·∫£ng gi√° ƒë√£ ch·ªçn");
							}
						}}
					/>
					<div className="flex justify-between">
						<div className="value-left value-info">{minmax[0].toLocaleString()} ƒë</div>
						<div className="value-right value-info">{minmax[1].toLocaleString()} ƒë</div>
					</div>
				</div>
				<div className="filter_seat">
					<p className="base__Body02Highlight-sc-1tvbuqk-15 cACxVN filter-name labelStyle font-bold">Ch·ªçn v·ªã tr√≠ gh·∫ø</p>
					<div className="flex justify-between">
						<p class="base__Body02-sc-1tvbuqk-14 VqdXU color--darkness">S·ªë gh·∫ø tr·ªëng</p>
						<div className="QuantityInput__Container-sc-5ap7dx-0 bcpLGl quantity-input Filter_AvailableSeats flex items-center justify-center">
							<button
								disabled={gheTrong > 1 ? false : true}
								type="button"
								className="ant-btn QuantityInput__RoundButton-sc-5ap7dx-1 jHictt"
								onClick={() => {
									if (gheTrong <= 1) return;

									const newValue = gheTrong - 1;
									setGheTrong(newValue);

									const filtered = originalListTripPassenger.filter((trip) => {
										const seatList = trip.vehicle?.seatVehicle || [];
										const emptySeats = seatList.filter((seat) => seat.status === "ch∆∞a ƒë·∫∑t").length;
										return emptySeats >= newValue;
									});

									dispatch({
										type: "GET_TRIP_PASSENGER",
										listTripPassenger: filtered,
									});
								}}
							>
								<Remove />
							</button>
							<div className="quantity-value mx-5 text-sm font-bold">
								<p className="base__SubHeadline-sc-1tvbuqk-8 jsMKgN color--darkness mb-0">{gheTrong}</p>
							</div>
							<button
								type="button"
								className="ant-btn QuantityInput__RoundButton-sc-5ap7dx-1 jHictt"
								onClick={() => {
									const newValue = gheTrong + 1;
									setGheTrong(newValue);

									const filtered = originalListTripPassenger.filter((trip) => {
										const seatList = trip.vehicle?.seatVehicle || [];
										// ƒê·∫øm s·ªë gh·∫ø tr·ªëng: gi·∫£ ƒë·ªãnh status === "available" l√† gh·∫ø tr·ªëng
										const emptySeats = seatList.filter((seat) => seat.status === "ch∆∞a ƒë·∫∑t").length;

										return emptySeats >= newValue;
									});

									dispatch({
										type: "GET_TRIP_PASSENGER",
										listTripPassenger: filtered,
									});
								}}
							>
								<AddCircleIcon />
							</button>
						</div>
					</div>

					{/* //Nh√† xe */}
					<div className="filter_passenger mt-5">
						<p className="base__Body02Highlight-sc-1tvbuqk-15 cACxVN filter-name labelStyle font-bold">Nh√† xe</p>
						<div className="mt-3 overflow-y-auto filer-passenger flex flex-col" style={{maxHeight: "100px"}}>
							{renderPassenger()}
						</div>
					</div>

					<div className="filter_typeseat mt-5">
						<p className="base__Body02Highlight-sc-1tvbuqk-15 cACxVN filter-name labelStyle font-bold">Lo·∫°i gh·∫ø / gi∆∞·ªùng</p>
						<div className="mt-3 filer-passenger">
							<Checkbox
								onChange={(e) => {
									if (e.target.checked) {
										dispatch(FilterSeatTripPassengerAction("seat"));
									} else {
										dispatch(getTripPassengerAction(props.id));
									}
								}}
							>
								Gh·∫ø ng·ªìi
							</Checkbox>
							<Checkbox
								onChange={(e) => {
									if (e.target.checked) {
										dispatch(FilterSeatTripPassengerAction("bed"));
									} else {
										dispatch(getTripPassengerAction(props.id));
									}
								}}
							>
								Gi∆∞·ªùng n·∫±m
							</Checkbox>
						</div>
					</div>
				</div>
				<div className="filter_vote">
					<p className="base__Body02Highlight-sc-1tvbuqk-15 cACxVN filter-name labelStyle font-bold">ƒê√°nh gi√°</p>
					<Rate
						allowHalf
						defaultValue={2.5}
						onChange={(e) => {
							if (listTripPassenger.length > 0) {
								dispatch(FilterRateTripPassengerAction(e));
							} else {
								dispatch(getTripPassengerAction(props.id));
							}
						}}
					/>
				</div>
			</Card>
		</div>
	);
}
